Metadata-Version: 2.4
Name: twins-recognition
Version: 0.1.0
Summary: Local twins/siblings/similarity recognition CLI and GUI
Author: tqmane
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: face_recognition
Requires-Dist: face-recognition-models
Requires-Dist: opencv-python
Requires-Dist: Pillow
Requires-Dist: numpy
Requires-Dist: dlib
Requires-Dist: Flask

# twins-recognition
ローカルのみで動作する簡易「双子 / 兄弟 / 類似 / 異なる人物」識別ツール。

## 概要
1枚の画像、またはフォルダ内の複数画像を処理し、各画像について検出された顔のペアの距離から以下のラベルを推定します:
- `twins` : 非常に近い（ほぼ同一の顔特徴）
- `siblings` : 双子ほどではないが近い特徴
- `similar` : それなりに似ている
- `different` : 類似度が低い
- `single_person` : 顔が1つだけ検出された
- `no_face` : 顔が検出されない

> 注意: これはヒューリスティック（簡易距離閾値）による推定であり、厳密な遺伝的・家族的関係を保証するものではありません。

## インストール
Python 3.10+ を推奨。

```
pip install -r requirements.txt
```

`dlib` のビルドが難しい環境では `face_recognition` のインストールが失敗する場合があります。その場合は Docker を使うか、別途ビルド手順を参照してください。

### もっと簡単に（推奨）
pyproject によりパッケージ化済みなので、以下だけでコマンドが使えます:

```
python -m venv .venv
source .venv/bin/activate
pip install -e .

# CLI
twins-cli --image path/to/photo.jpg --pretty

# GUI
twins-gui
```

### 簡潔表示オプション

大量の画像を扱うときに JSON 全体を見たくない場合は `--brief` で 1 行 / 画像 のタブ区切り出力、`--summary` で集計を表示できます。

例:
```
twins-cli --folder ./images --brief --summary
```
出力例:
```
twins	0.305	2	/path/to/img1.jpg
no_face	-	0	/path/to/img2.png

# summary
twins: 1 (50.0%)
no_face: 1 (50.0%)
mean_distance: 0.305
median_distance: 0.305
```

Makefile も用意しています:

```
make install    # .venv 作成 + pip install -e .
make cli        # CLIのヘルプ
make gui        # GUI を起動
make dev        # pytest など開発ツール導入
make test       # テスト実行
```

Docker で試す場合:

```
docker build -t twins-recognition .
docker run --rm -v "$PWD":/work -w /work twins-recognition twins-cli --help
```

## 使い方 (CLI)

単一画像:
```
python -m twins_recognition.cli --image path/to/photo.jpg --pretty
```

フォルダ一括:
```
python -m twins_recognition.cli --folder path/to/folder --pretty
```

結果をファイルへ保存:
```
python -m twins_recognition.cli --image sample.jpg --output result.json --pretty
```

## GUI

```
python -m twins_recognition.gui
```
ウィンドウが開いたら「画像を選択」または「フォルダを選択」で処理。結果はテーブル表示されます。

対応画像形式（拡張子）: jpg, jpeg, png, bmp, webp, tif, tiff, gif, jp2, ppm, pnm, pbm, pgm
（注: HEIC/AVIFは標準では未対応。Pillow用プラグイン導入で対応可能ですが、本ツールでは標準外です）

## 判定ロジック
`src/twins_recognition/classifier.py` 内の `THRESHOLDS` 定数で距離境界を調整できます。

距離は `face_recognition` の 128 次元埋め込み間ユークリッド距離です:

| ラベル | 距離条件 (初期値) |
|--------|-------------------|
| twins | <= 0.40 |
| siblings | <= 0.55 |
| similar | <= 0.60 |
| different | > 0.60 |

3人以上写っている場合は、最も距離の小さいペアを代表として分類し、`faces_count` として総顔数を detail に含めます。

## 制限事項 / 注意
- 照明・角度・表情差で距離は大きく変動します。
- 実際の双子かどうかの医学的判定は行えません。
- 顔検出失敗や誤検出があると結果が不正確になります。
- オフライン処理のため学習・微調整は行っていません。

## テスト
```
pytest -q
```
`tests/test_classifier.py` で閾値境界の単体テストを実施しています。

## 次の改善候補
- Embedding の正規化とコサイン距離併用
- 画像前処理 (明るさ補正, アライン)
- 閾値自動調整用スクリプト
- dlib 不要な軽量モード (mediapipe など)

